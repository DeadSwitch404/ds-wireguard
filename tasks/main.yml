---
- name: Install wireguard
  ansible.builtin.apt:
    name: wireguard
    state: present

- name: Ensure /etc/wireguard exists
  ansible.builtin.file:
    path: /etc/wireguard
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: Check if private key file already exists
  ansible.builtin.stat:
    path: /etc/wireguard/server_private.key
  register: private

- name: Private key handling
  when: (not private.stat.exists) and (vault_wg_private_key is not defined)
  block:
    - name: Generate the private key
      ansible.builtin.shell: umask 077 && wg genkey > server_private.key
      args:
        chdir: /root

    - name: Generate the public key
      ansible.builtin.shell: wg pubkey < server_private.key > server_public.key
      args:
        chdir: /root

    - name: Move the private key to its place
      ansible.builtin.copy:
        src: /root/server_private.key
        dest: /etc/wireguard/server_private.key
        remote_src: true
        owner: root
        group: root
        mode: '0400'

    - name: Move the public key to its place
      ansible.builtin.copy:
        src: /root/server_public.key
        dest: /etc/wireguard/server_public.key
        remote_src: true
        owner: root
        group: root
        mode: '0400'

    - name: Cleanup the leftover keys in /root
      ansible.builtin.file:
        name: "{{ item }}"
        state: absent
      loop:
        - /root/server_private.key
        - /root/server_public.key

- name: Write vault private key if provided
  ansible.builtin.copy:
    content: "{{ vault_wg_private_key }}"
    dest: /etc/wireguard/server_private.key
    owner: root
    group: root
    mode: '0400'
  when: vault_wg_private_key is defined
  notify: Get_public_key

- name: Enable local IP forwarding in the kernel
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    sysctl_file: /etc/sysctl.d/wireguard.conf
    reload: true

- name: Enable local IP forwarding in UFW
  ansible.builtin.lineinfile:
    path: /etc/ufw/sysctl.conf
    regexp: '^net.ipv4.ip_forward'
    line: 'net.ipv4.ip_forward=1'
  notify: Restart_UFW

- name: Allow NAT postrouting in UFW
  ansible.builtin.blockinfile:
    path: /etc/ufw/before.rules
    insertbefore: '^\*filter'
    block: |
      *nat
      :POSTROUTING ACCEPT [0:0]
      -A POSTROUTING -s {{ wg_vpn_network }} -o {{ wg_network_interface }} -j MASQUERADE
      COMMIT
  notify: Restart_UFW

- name: Enable routing in UFW
  community.general.ufw:
    route: true
    rule: allow
    interface_in: "{{ wg_vpn_interface }}"
    interface_out: "{{ wg_network_interface }}"
  notify: Restart_UFW

- name: Read Wireguard private key
  ansible.builtin.slurp:
    src: /etc/wireguard/server_private.key
  register: wg_private

- name: Deploy the wireguard configuration
  ansible.builtin.template:
    src: wg0.conf.j2
    dest: /etc/wireguard/wg0.conf
    owner: root
    group: root
    mode: '0600'
  notify: Restart_WireGuard
  vars:
    wg_private_key: "{{ wg_private['content'] | b64decode }}"

- name: Enable and start WireGuard
  ansible.builtin.service:
    name: wg-quick@wg0
    enabled: true
    state: started
  notify: Restart_WireGuard
